import { NextRequest, NextResponse } from 'next/server';

export async function POST(req: NextRequest) {
  try {
    const { content, category, practiceType } = await req.json();
    if (!content || typeof content !== 'string') {
      return NextResponse.json({ error: 'Invalid content provided' }, { status: 400 });
    }
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return NextResponse.json({ error: 'API Key not set' }, { status: 500 });
    }

    const starRatingGuide = `
- 아래 5가지 항목에 대해 각각 5점 만점(★☆☆☆☆ ~ ★★★★★)으로 별점을 매기고, **아래와 같이 Markdown 표 형식(별점 평가)**으로 먼저 제시해줘:

별점 평가
| 항목 | 별점 | 한 줄 평가 |
| --- | --- | --- |
| 문장력과 묘사력 | ★★★☆☆ | ... |
| 흐름과 개연성 | ★★★☆☆ | ... |
| 몰입감과 주제 전달 | ★★★☆☆ | ... |
| 창의성과 독창성 | ★★★☆☆ | ... |
| 전체적 완성도 | ★★★☆☆ | ... |

- 평균 점수에 따라 아래 기준으로 글 수준을 분류해줘:
  - 4.5점 이상: 매우 뛰어난 글
  - 3.5~4.4점: 잘 쓴 글
  - 2.5~3.4점: 평범한 글
  - 2.4점 이하: 부족한 글
- 별점 평균에 따라 피드백 강도와 스타일을 달리해줘(칭찬/중립/구체적 개선/냉정한 비판 등).
`;

    const screenplayStarRatingGuide = `
- 아래 5가지 항목에 대해 각각 5점 만점(★☆☆☆☆ ~ ★★★★★)으로 별점을 매기고, **아래와 같이 Markdown 표 형식(별점 평가)**으로 먼저 제시해줘:

별점 평가
| 항목 | 별점 | 한 줄 평가 |
| --- | --- | --- |
| 장면 구성력 | ★★★☆☆ | ... |
| 대사의 자연스러움과 전달력 | ★★★☆☆ | ... |
| 전개와 흐름의 매끄러움 | ★★★☆☆ | ... |
| 캐릭터 표현력과 입체감 | ★★★☆☆ | ... |
| 전체적 완성도 | ★★★☆☆ | ... |

- 평균 점수에 따라 아래 기준으로 글 수준을 분류해줘:
  - 4.5점 이상: 매우 뛰어난 글
  - 3.5~4.4점: 잘 쓴 글
  - 2.5~3.4점: 평범한 글
  - 2.4점 이하: 부족한 글
- 별점 평균에 따라 피드백 강도와 스타일을 달리해줘(칭찬/중립/구체적 개선/냉정한 비판 등).
`;

    const poetryStarRatingGuide = `
- 아래 5가지 항목에 대해 각각 5점 만점(★☆☆☆☆ ~ ★★★★★)으로 별점을 매기고, **아래와 같이 Markdown 표 형식(별점 평가)**으로 먼저 제시해줘:

별점 평가
| 항목 | 별점 | 한 줄 평가 |
| --- | --- | --- |
| 언어의 감수성과 표현력 | ★★★☆☆ | ... |
| 시적 구조와 리듬감 | ★★★☆☆ | ... |
| 주제의 명확성 및 상징성 | ★★★☆☆ | ... |
| 창의성과 개성 | ★★★☆☆ | ... |
| 전체적 완성도 | ★★★☆☆ | ... |

- 평균 점수에 따라 아래 기준으로 글 수준을 분류해줘:
  - 4.5점 이상: 매우 뛰어난 글
  - 3.5~4.4점: 잘 쓴 글
  - 2.5~3.4점: 평범한 글
  - 2.4점 이하: 부족한 글
- 별점 평균에 따라 피드백 강도와 스타일을 달리해줘(칭찬/중립/구체적 개선/냉정한 비판 등).
`;

    const essayStarRatingGuide = `
- 아래 5가지 항목에 대해 각각 5점 만점(★☆☆☆☆ ~ ★★★★★)으로 별점을 매기고, **아래와 같이 Markdown 표 형식(별점 평가)**으로 먼저 제시해줘:

별점 평가
| 항목 | 별점 | 한 줄 평가 |
| --- | --- | --- |
| 논리 전개와 구성력 | ★★★☆☆ | ... |
| 문장 표현력과 전달력 | ★★★☆☆ | ... |
| 주제의 명확성과 설득력 | ★★★☆☆ | ... |
| 진정성과 공감도 | ★★★☆☆ | ... |
| 전체적 완성도 | ★★★☆☆ | ... |

- 평균 점수에 따라 아래 기준으로 글 수준을 분류해줘:
  - 4.5점 이상: 매우 뛰어난 글
  - 3.5~4.4점: 잘 쓴 글
  - 2.5~3.4점: 평범한 글
  - 2.4점 이하: 부족한 글
- 별점 평균에 따라 피드백 강도와 스타일을 달리해줘(칭찬/중립/구체적 개선/냉정한 비판 등).
`;
    const subjectGenreGuide = `
- 반드시 문제에서 제시한 주제와 장르(예: "속삭이는 그림자", "스팀펑크 톤" 등)가 글에 잘 반영되었는지 평가 항목에 포함해줘.
- 주제와 장르가 잘 드러났는지, 그에 맞는 분위기/스타일/상징/어휘/구성 등이 적절한지 구체적으로 언급해줘.
`;
    const feedbackFormatGuide = `
- 피드백은 다음 순서와 형식으로 제공:
  1) 별점 평가(표)
  2) 감상(3~5문장)
  3) 피드백(별점에 따라 강도/스타일 다르게)
  4) 개선안(2~3가지)
  5) 코멘트(1~2문장)
- 각 항목은 진심 어린 조언, 다양한 어조(감정 몰입형, 평론가형, 편집자형, 멘토형 등)로 랜덤하게 작성.
- 글이 너무 짧거나 주제에서 벗어나면 냉정한 비판도 허용.
`;
      const practiceSpecificPrompts = {
      '필사 연습': `너는 글쓰기 교정자이자 독자야. 아래는 필사 연습을 위해 사용된 글이야. 이 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 필사 연습의 관점에서 문체, 리듬, 어휘, 원문 모방의 정확성, 현대적 변주 가능성도 함께 평가해줘.
`,
      '문제 풀이': `너는 글쓰기 문제를 채점하고 피드백하는 코치야. 아래 글은 주어진 문제를 풀어서 작성된 글이야. 이 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 문제 요구사항 충족, 논리 전개, 창의성, 구조적 완성도, 주제/장르 반영 여부를 함께 평가해줘.
`,
      '테마별 글쓰기': `너는 특정 주제(테마) 글을 평가하는 독자 겸 큐레이터야. 아래 글은 특정 테마에 맞춰 작성된 글이야. 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 테마 전달력, 분위기, 상징성, 주제/장르 반영 여부를 함께 평가해줘.
`,
      '제작성 훈련': `너는 상상력과 창작성을 평가하는 이야기 개발자 역할이야. 아래 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 창작적 발상, 독창성, 서사의 탄탄함, 주제/장르 반영 여부를 함께 평가해줘.
`,
      '5감각 묘사 연습': `너는 감각적 묘사와 몰입감을 평가하는 문학 평론가 역할이야. 아래 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 오감 묘사의 생생함, 구체성, 이미지의 선명도, 주제/장르 반영 여부를 함께 평가해줘.
`,
      '한 문장 소설': `너는 짧고 강렬한 글을 평가하는 미니픽션 편집자야. 아래 글(한 문장 소설)을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **함축적 서사력(Condensed Storytelling)**: 한 문장 안에 상황, 인물, 갈등, 여운이 얼마나 압축적으로 담겼는지, 군더더기 없는 구조인지 평가
  2) **강렬한 첫인상과 후킹(Hook)**: 짧아도 독자의 상상력을 자극하거나 여운을 남기는 결말인지, 첫 문장이 강렬한지 평가
  3) **감정·분위기·상징 표현**: 감정을 직접적으로 말하지 않고 이미지/행동/상징으로 잘 표현했는지, 다양한 톤(로맨스, 공포, 미스터리 등) 시도가 있는지 평가
  4) **문장 리듬과 간결성**: 단문, 비유, 반복, 대조 등으로 한 문장을 강하게 만들었는지, 군더더기 없이 단어 하나하나가 살아있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 위 포인트별로 제시해줘.
- 이 연습이 SNS/광고 카피, 소설의 핵심 문장 작성에도 도움이 된다는 점을 참고해, 실제로 그런 관점에서 피드백을 줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '이어쓰기': `너는 이어쓰기로 진행된 이야기의 흐름과 톤을 평가하는 편집자야. 아래 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 연결의 매끄러움, 캐릭터와 사건의 일관성, 주제/장르 반영 여부를 함께 평가해줘.
`,
      '시점 변화 연습': `너는 시점 전환과 서술 흐름을 평가하는 문학 교정자야. 아래 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 시점의 일관성, 전환의 부드러움, 주제/장르 반영 여부를 함께 평가해줘.
`,
      // 시나리오 연습 방식들
      '대사 작성': `너는 시나리오 대사 전문가이자 연극/영화 감독 역할이야. 아래 대사를 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **자연스러운 대화 흐름**: 인물들이 실제로 말할 법한 자연스러운 대화인지, 각자의 성격이 드러나는지 평가
  2) **서브텍스트와 함축적 의미**: 표면적 대화 뒤에 숨겨진 감정, 갈등, 욕망이 잘 표현되었는지 평가
  3) **리듬과 페이스**: 대화의 속도감, 휴식, 강조점이 적절한지, 긴장감과 이완이 잘 조화되었는지 평가
  4) **시각적 연출 가능성**: 배우가 연기하기 좋은 대사인지, 무대/화면에서 효과적으로 표현될 수 있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '장르 변환': `너는 장르 문학 전문가이자 스토리텔링 코치야. 아래 장르 변환 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **장르 특성의 정확한 반영**: 각 장르(로맨스, 스릴러, SF, 판타지 등)의 고유한 요소들이 잘 드러났는지 평가
  2) **분위기와 톤의 일관성**: 장르에 맞는 분위기, 어조, 스타일이 일관되게 유지되었는지 평가
  3) **장르별 관습과 클리셰 활용**: 해당 장르의 전형적 요소들을 창의적으로 활용했는지 평가
  4) **독창성과 변주**: 원작을 단순 모방이 아닌 새로운 해석으로 발전시켰는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '상황극/역할극': `너는 연극 전문가이자 연출가 역할이야. 아래 상황극/역할극 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **상황 설정의 명확성**: 배경, 시간, 인물 관계가 명확하게 설정되었는지 평가
  2) **캐릭터의 개성과 동기**: 각 인물의 성격, 목적, 갈등이 잘 드러나는지 평가
  3) **대화의 자연스러움과 긴장감**: 인물들 간의 대화가 자연스럽고 긴장감을 유지하는지 평가
  4) **연극적 효과**: 무대에서 연출하기 좋은 요소들이 포함되었는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '장면 전환': `너는 영화 편집자이자 시나리오 전문가야. 아래 장면 전환 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **전환의 매끄러움**: 장면 간 연결이 자연스럽고 이해하기 쉬운지 평가
  2) **시각적 연속성**: 전환 방식(페이드, 크로스컷, 점프컷 등)이 적절한지 평가
  3) **감정적 흐름**: 전환이 감정적 흐름을 방해하지 않고 오히려 강화하는지 평가
  4) **서사적 효과**: 전환이 이야기 전개에 도움이 되는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '시나리오 구조화': `너는 시나리오 구조 전문가이자 스토리 아키텍트야. 아래 시나리오 구조화 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **구조의 명확성**: 3막 구조, 5막 구조 등이 명확하게 구분되는지 평가
  2) **갈등과 전개**: 각 장면이 갈등을 발전시키고 해결하는지 평가
  3) **캐릭터 아크**: 인물의 변화와 성장이 구조에 반영되었는지 평가
  4) **클라이맥스와 해결**: 고조점과 결말이 효과적으로 배치되었는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '장면 묘사': `너는 시각적 묘사 전문가이자 영화 감독 역할이야. 아래 장면 묘사 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **시각적 구체성**: 독자가 장면을 머릿속에 그릴 수 있을 정도로 구체적인지 평가
  2) **분위기와 톤**: 장르에 맞는 분위기와 감정이 잘 표현되었는지 평가
  3) **세부 묘사의 적절성**: 중요한 세부사항은 강조하고 불필요한 것은 생략했는지 평가
  4) **시각적 리듬**: 묘사의 속도감과 리듬이 적절한지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '즉흥 시나리오': `너는 즉흥 창작 전문가이자 스토리텔링 코치야. 아래 즉흥 시나리오 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **즉흥성과 자연스러움**: 즉석에서 만들어낸 것처럼 자연스럽고 생동감 있는지 평가
  2) **창의적 발상**: 예상치 못한 아이디어나 전개가 있는지 평가
  3) **구조적 완성도**: 즉흥이지만 완결된 이야기 구조를 가지고 있는지 평가
  4) **감정적 몰입**: 독자가 이야기에 빠져들 수 있는 감정적 요소가 있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '결말 재구성': `너는 스토리 엔딩 전문가이자 시나리오 에디터야. 아래 결말 재구성 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **결말의 다양성**: 각 결말이 서로 다른 방향과 감정을 제시하는지 평가
  2) **개연성과 설득력**: 각 결말이 이야기의 흐름에 자연스럽게 이어지는지 평가
  3) **감정적 충격**: 각 결말이 독자에게 강한 감정적 충격을 주는지 평가
  4) **완성도와 여운**: 각 결말이 완결감을 주면서도 여운을 남기는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      // 시 연습 방식들
      '이미지화': `너는 시적 이미지 전문가이자 문학 평론가야. 아래 이미지화 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **시각적 이미지의 선명도**: 독자가 머릿속에 그림을 그릴 수 있을 정도로 구체적인지 평가
  2) **감각적 표현**: 시각뿐만 아니라 청각, 촉각 등 다양한 감각을 활용했는지 평가
  3) **상징과 은유**: 이미지가 단순 묘사를 넘어 상징적 의미를 담고 있는지 평가
  4) **시적 리듬**: 이미지의 배열이 시적 리듬감을 만들어내는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '운율 맞추기': `너는 운율 전문가이자 시학 교수야. 아래 운율 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **운율의 정확성**: 끝소리나 중간 운율이 일정하게 맞춰졌는지 평가
  2) **자연스러운 운율**: 억지스럽지 않고 자연스럽게 운율이 맞춰졌는지 평가
  3) **의미와 운율의 조화**: 운율을 맞추느라 의미가 희생되지 않았는지 평가
  4) **시적 효과**: 운율이 시의 분위기와 감정을 강화하는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '시어 변형': `너는 시어 전문가이자 문학 교정자야. 아래 시어 변형 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **변형의 창의성**: 원문을 단순 바꿈이 아닌 창의적으로 재해석했는지 평가
  2) **시적 표현의 효과**: 변형된 표현이 시적 효과를 높이는지 평가
  3) **의미의 깊이**: 변형을 통해 더 깊은 의미를 담았는지 평가
  4) **문체의 일관성**: 변형된 표현들이 하나의 문체로 통일되는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '감각 분리 시': `너는 감각 시 전문가이자 문학 평론가야. 아래 감각 분리 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **감각의 순수성**: 한 감각에 집중하여 다른 감각의 개입을 최소화했는지 평가
  2) **감각 표현의 정확성**: 해당 감각의 특성을 정확하게 포착했는지 평가
  3) **시적 효과**: 감각 분리가 시의 몰입감을 높이는지 평가
  4) **상상력의 자극**: 독자의 해당 감각을 자극하는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '즉흥시': `너는 즉흥 시 전문가이자 시인 멘토야. 아래 즉흥시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **즉흥성과 생동감**: 즉석에서 쓴 것처럼 생동감 있고 자연스러운지 평가
  2) **감정의 진실성**: 진심 어린 감정이 담겨 있는지 평가
  3) **시적 리듬**: 즉흥적이지만 시적 리듬을 가지고 있는지 평가
  4) **창의적 표현**: 예상치 못한 표현이나 이미지가 있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '시 구조 변형 연습': `너는 시 구조 전문가이자 문학 교정자야. 아래 시 구조 변형 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **구조 변형의 적절성**: 각 형식(자유시, 3행시, 하이쿠, 산문시)의 특성을 잘 살렸는지 평가
  2) **내용과 형식의 조화**: 형식이 내용을 효과적으로 담아내는지 평가
  3) **변형의 창의성**: 단순 형식 바꿈이 아닌 창의적 재해석인지 평가
  4) **시적 완성도**: 각 형식에서 완결된 시가 되었는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '주제 변주': `너는 주제 변주 전문가이자 문학 평론가야. 아래 주제 변주 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **주제의 일관성**: 변주를 통해 주제가 더욱 명확해졌는지 평가
  2) **변주의 다양성**: 같은 주제를 다양한 각도에서 다뤘는지 평가
  3) **시적 깊이**: 변주를 통해 주제의 깊이가 더해졌는지 평가
  4) **통일성과 변화**: 변주가 있으면서도 전체적 통일감을 유지하는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '한 문장 시': `너는 미니픽션 시 전문가이자 시인 멘토야. 아래 한 문장 시를 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **함축적 표현**: 한 문장 안에 깊은 의미가 압축되어 있는지 평가
  2) **시적 완성도**: 한 문장이 완결된 시가 되었는지 평가
  3) **감정의 강렬함**: 짧지만 강한 감정적 충격을 주는지 평가
  4) **상상력의 자극**: 독자의 상상력을 자극하는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      // 에세이 연습 방식들
      '주제 에세이': `너는 에세이 전문가이자 문학 교정자야. 아래 주제 에세이를 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **주제 전달력**: 주제가 명확하고 효과적으로 전달되는지 평가
  2) **개인적 관점**: 작가만의 독특한 시각과 경험이 담겨 있는지 평가
  3) **문체의 자연스러움**: 에세이에 적합한 자연스러운 문체인지 평가
  4) **감정의 진실성**: 진심 어린 감정과 생각이 담겨 있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '논증/설득': `너는 논증문 전문가이자 논리학 교수야. 아래 논증/설득 에세이를 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **논리적 구조**: 주장-근거-반론-재반론의 구조가 명확한지 평가
  2) **근거의 설득력**: 제시된 근거가 타당하고 설득력 있는지 평가
  3) **반론 처리**: 예상되는 반론을 적절히 다루었는지 평가
  4) **객관적 톤**: 감정적이 아닌 논리적이고 객관적인 톤인지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '요약/확장': `너는 요약문 전문가이자 글쓰기 코치야. 아래 요약/확장 글을 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **핵심 내용 파악**: 원문의 핵심을 정확히 파악했는지 평가
  2) **구조적 완성도**: 요약이든 확장이든 완결된 구조를 가지고 있는지 평가
  3) **정보의 정확성**: 원문의 정보를 왜곡하지 않고 정확히 전달했는지 평가
  4) **창의적 재구성**: 단순 복사가 아닌 창의적 재구성인지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '감상문': `너는 문학 평론가이자 독서 지도사야. 아래 감상문을 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **감상의 깊이**: 표면적 감상이 아닌 깊이 있는 분석인지 평가
  2) **개인적 체험**: 작품과 자신의 경험을 연결한 개인적 감상인지 평가
  3) **작품 이해도**: 작품의 주제와 의도를 정확히 파악했는지 평가
  4) **감정의 진실성**: 진심 어린 감정과 생각이 담겨 있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '비유/은유 연습': `너는 문학적 표현 전문가이자 시인 멘토야. 아래 비유/은유 연습 글을 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **비유의 적절성**: 비유가 원래 대상의 특성을 잘 드러내는지 평가
  2) **창의적 표현**: 상투적이 아닌 창의적인 비유인지 평가
  3) **이해의 용이성**: 독자가 쉽게 이해할 수 있는 비유인지 평가
  4) **문학적 효과**: 비유가 글의 문학적 효과를 높이는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      '편지 에세이': `너는 편지문 전문가이자 문학 교정자야. 아래 편지 에세이를 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **대화체의 자연스러움**: 편지 형식에 맞는 자연스러운 대화체인지 평가
  2) **감정의 진실성**: 진심 어린 감정과 생각이 담겨 있는지 평가
  3) **대상과의 연결**: 편지 받는 대상과의 관계가 잘 드러나는지 평가
  4) **개인적 색채**: 작가만의 독특한 관점과 경험이 담겨 있는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 주제/장르(문제에서 제시된 키워드/톤 등) 반영 여부도 반드시 평가에 포함.
`,
      // 소설 자유 글쓰기
      '소설 자유': `너는 소설 전문가이자 출판 편집자 역할이야. 아래 소설 글을 읽고 피드백을 줘.
${starRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **캐릭터와 인물 묘사**: 인물의 성격, 동기, 변화가 잘 드러나는지 평가
  2) **서사 구조와 플롯**: 이야기의 흐름, 갈등, 전개가 자연스러운지 평가
  3) **묘사와 분위기**: 장면, 감정, 분위기가 생생하게 표현되었는지 평가
  4) **대화와 서술**: 대화의 자연스러움, 서술의 리듬이 적절한지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 소설적 요소(캐릭터, 플롯, 서사)에 집중해서 평가해줘.
`,

      // 시나리오 자유 글쓰기
      '시나리오 자유': `너는 시나리오 전문가이자 영화/연극 감독 역할이야. 아래 시나리오 글을 읽고 피드백을 줘.
${screenplayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **시각적 묘사**: 장면, 동작, 배경이 화면에 보이는 것처럼 구체적인지 평가
  2) **대화와 대사**: 인물들의 대화가 자연스럽고 각자의 성격이 드러나는지 평가
  3) **장면 구성**: 장면 전환, 페이스, 리듬이 적절한지 평가
  4) **연출 가능성**: 배우가 연기하고 카메라로 촬영하기 좋은 구성인지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 시각적 묘사, 대화, 장면 구성에 집중해서 평가해줘.
`,

      // 시 자유 글쓰기
      '시 자유': `너는 시 전문가이자 시인 역할이야. 아래 시 글을 읽고 피드백을 줘.
${poetryStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **이미지와 상징**: 시적 이미지, 상징, 비유가 효과적인지 평가
  2) **운율과 리듬**: 시의 음악성, 리듬, 운율이 적절한지 평가
  3) **감정과 분위기**: 감정의 진실성, 분위기 전달이 잘 되는지 평가
  4) **집약성과 함축**: 짧은 분량에 깊은 의미가 담겼는지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 이미지, 운율, 시적 표현에 집중해서 평가해줘.
`,

      // 에세이 자유 글쓰기
      '에세이 자유': `너는 에세이 전문가이자 문학 교정자 역할이야. 아래 에세이 글을 읽고 피드백을 줘.
${essayStarRatingGuide}${subjectGenreGuide}${feedbackFormatGuide}
- 반드시 아래 핵심 포인트별로 구체적으로 피드백해줘:
  1) **개인적 경험과 사색**: 개인적 경험이 진실되고 사색이 깊은지 평가
  2) **논리와 구조**: 생각의 흐름, 논리적 전개가 명확한지 평가
  3) **문체와 표현**: 개성 있는 문체, 적절한 표현이 사용되었는지 평가
  4) **주제와 메시지**: 주제 의식, 메시지 전달이 효과적인지 평가
- 각 포인트별로 장점/아쉬운 점을 구체적으로 언급하고, 개선안도 제시해줘.
- 논리, 개인적 경험, 사색에 집중해서 평가해줘.
`,

      // 기존 자유 글쓰기 (기본값)
      '자유': `너는 글쓰기 코치이자 다양한 독자 역할을 맡는 피드백 전문가야. 아래 글을 읽고, 마치 한 명의 독자로서 글을 감상하고, 동시에 작가가 성장할 수 있는 깊이 있는 피드백을 줘.

출력은 다음 순서와 기준을 따를 것:

1) **글 수준 평가 (별점 5점 만점)**  
   다음 5가지 기준으로 각각 별점을 매기고, 평균 점수에 따라 글의 전체 수준을 판단해줘:
   - **문장력과 묘사력 (Sentence & Imagery)**
   - **흐름과 개연성 (Flow & Coherence)**
   - **몰입감과 주제 전달 (Engagement & Theme)**
   - **창의성과 독창성 (Creativity & Originality)**
   - **전체적 완성도 (Overall Polish)**
   **아래와 같이 Markdown 표로 별점 평가를 먼저 제시해줘:**
   
   별점 평가
   | 항목 | 별점 | 한 줄 평가 |
   | --- | --- | --- |
   | 문장력과 묘사력 | ★★★☆☆ | ... |
   | 흐름과 개연성 | ★★★☆☆ | ... |
   | 몰입감과 주제 전달 | ★★★☆☆ | ... |
   | 창의성과 독창성 | ★★★☆☆ | ... |
   | 전체적 완성도 | ★★★☆☆ | ... |
   
   **평균 점수에 따른 글 수준 분류:**
   - 4.5점 이상: **매우 뛰어난 글** (거의 완벽한 수준)
   - 3.5~4.4점: **잘 쓴 글** (상당히 좋은 수준)
   - 2.5~3.4점: **평범한 글** (보통 수준)
   - 2.4점 이하: **부족한 글** (개선이 필요한 수준)

2) **감상 (3~6문장)**  
   - 글을 읽고 느낀 감정, 몰입도, 주제 전달력, 인상 깊은 부분을 솔직히 적어줘.  
   - **매우 뛰어난 글**: 큰 칭찬과 응원을 먼저 하고, 독자로서 느낀 감동과 울림을 강조해줘.
   - **잘 쓴 글**: 칭찬과 인상 위주로 시작하되, 글의 스타일에 따라 감정적으로 몰입하거나 차분하게 평가해도 좋다.
   - **평범한 글**: 노력과 의지를 인정하면서 시작해줘.
   - **부족한 글**: 그래도 노력과 의지를 인정하면서 시작해줘.
   - 제목 없이 내용만 작성.

3) **피드백 (강도·스타일 가변)**  
   - 글의 완성도에 따라 피드백 강도를 다르게:
     - **매우 뛰어난 글**: 칭찬을 중심으로, "꼭 필요하진 않지만 이런 시도도 가능하다"는 조언형 피드백을 1~2개만 제시. 작가의 재능을 인정하면서도 더욱 성장할 수 있는 방향을 제시해줘.
     - **잘 쓴 글**: 칭찬 + "이렇게도 표현할 수 있다" 식의 대안 1~2개 제시.
     - **평범한 글**: 중립적으로 분석하며 2~3가지 개선 포인트 제시.
     - **부족한 글**: 냉철하지만 구체적인 피드백(3개 이상) 제시하되, 감상과 조언도 함께 해서 혹평으로만 보이지 않게.
   - 문장력, 개연성, 몰입감, 주제 전달력을 기본 평가 축으로 삼되, 상황에 따라 감정선, 문체, 리듬, 창의성, 독창성도 다룬다.

4) **구체적 개선안**  
   - 중요한 문장이나 부분을 1~2개 골라 **수정 예시 2~3가지**를 제공.
   - **매우 뛰어난 글**: "필수는 아니지만 이렇게도 표현할 수 있다"는 선택적 개선안 형태로 제시.
   - 단순 교정이 아니라, 의미나 분위기를 살리면서 다양한 선택지를 보여준다.

5) **코멘트 (1~2문장)**  
   - 마지막에는 마치 실제 독자가 느낀 한 줄 감상처럼, 간단한 코멘트로 마무리.
   - **매우 뛰어난 글**: 진심 어린 응원이나 기대감을 담은 코멘트로 마무리.
   - 예: "이 장면은 개인적으로 오래 기억에 남을 것 같아요." / "이 글을 조금만 다듬으면 출판작으로도 손색없습니다." / "당신의 재능이 정말 대단해요. 앞으로의 작품들이 기대됩니다."
   - 제목 없이 내용만 작성.

6) **톤 다양화**  
   - 매번 같은 어조를 쓰지 말고, 글의 완성도와 스타일에 따라:
     - **감정 몰입형** (열정적인 독자처럼 감동을 표현),
     - **문학 평론가형** (분석적이고 차분한 평가),
     - **출판 편집자형** (실무적인 조언과 격려),
     - **캐주얼 독자형** (친근하게 감상 나누기),
     - **멘토형** (진심 어린 조언과 응원)
     등으로 피드백 톤을 랜덤하게 섞어서 반복 패턴을 피한다.

**전체적인 목표:**
사용자가 피드백을 읽고 감동받고, 더욱 글쓰기에 대한 동기와 자신감을 얻을 수 있도록 진심 어린 격려와 구체적인 조언을 제공해줘.`
      };

      const specificPrompt = practiceSpecificPrompts[practiceType as keyof typeof practiceSpecificPrompts] || practiceSpecificPrompts['자유'];

    const prompt = `${specificPrompt}다음 형식으로 피드백을 제공해줘:

- 별점 평가(표)
- 감상 (3~5문장)
- 좋은 점 (구체적인 장점들을 - 기호로 나열)
- 개선점 (구체적인 개선점들을 - 기호로 나열)
- 최후통첩 (전체적인 평가와 앞으로의 발전 방향)
- 구체적 개선안 (중요 문장/부분의 수정 예시 2~3가지)
- 코멘트 (1~2문장, 반드시 포함)

**아래 항목 중 하나라도 누락하지 말고 반드시 모두 포함해서 출력할 것. 만약 쓸 내용이 없으면 '없음'이라고라도 반드시 출력할 것.**

만약 글이 너무 짧거나 주제에서 벗어났다면 냉정한 비판도 허용한다.

사용자의 글:
${content}`;

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4-turbo',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 1500,
        temperature: 0.7,
      }),
    });

    const data = await response.json();
    if (!response.ok) {
      return NextResponse.json({ error: data.error?.message || 'OpenAI API Error', details: data.error }, { status: 500 });
    }
    const result = data.choices?.[0]?.message?.content || '';
    if (!result.trim()) {
      return NextResponse.json({ error: 'Empty response from AI' }, { status: 500 });
    }
    return NextResponse.json({ result });
  } catch (error) {
    return NextResponse.json({ error: 'Internal server error', details: error instanceof Error ? error.message : 'Unknown error' }, { status: 500 });
  }
} 